{# Install the rapids-notebook-env meta-pkg #}
RUN ${RAPIDS_DIR}/utils/condaretry install -y -n rapids --freeze-installed \
    rapids-notebook-env=${RAPIDS_CONDA_VERSION_SPEC} \
  && conda clean -afy \
  && chmod -R ugo+w /opt/conda

{# Install jupyter lab stuff #}
RUN source activate rapids \
  && pip install "git+https://github.com/rapidsai/jupyterlab-nvdashboard.git@main#egg=jupyterlab-nvdashboard" --upgrade \
  && jupyter labextension install dask-labextension jupyterlab-nvdashboard

{# Install notebooks repo #}
RUN cd ${RAPIDS_DIR} \
  && source activate rapids \
  && git clone -b branch-{{ RAPIDS_VERSION }} --depth 1 --single-branch https://github.com/rapidsai/notebooks.git \
  && cd notebooks \
  && git submodule update --init --remote --recursive --no-single-branch --depth 1 \
  && chmod -R ugo+w /opt/conda ${RAPIDS_DIR}

{# Add test file for testing notebooks from within the container #}
COPY test.sh test-nbcontrib.sh /

WORKDIR ${RAPIDS_DIR}/notebooks
{# Jupyter notebook port #}
EXPOSE 8888
{# Dask Scheduler Bokeh port #}
EXPOSE 8787
EXPOSE 8786

{# Change the entrypoint to start the Jupyter server prior to running commands #}
COPY .start_jupyter_run_in_rapids.sh /.run_in_rapids
