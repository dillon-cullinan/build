{# This partial clones the CLX repo and build and installs it into the rapids conda env. #}

{# Install build prerequisites #}
RUN source activate rapids && \
    gpuci_conda_retry install -y -n rapids -c pytorch \
        "pytorch=1.7.1" \
        torchvision \
        "cudf_kafka=${RAPIDS_VER}" \
        "custreamz=${RAPIDS_VER}" \
        "transformers=4.*" \
        seqeval \
        python-whois \
        faker && \
    pip install "git+https://github.com/rapidsai/cudatashader.git" && \
    pip install mockito && \
    pip install wget && \
    pip install "git+https://github.com/slashnext/SlashNext-URL-Analysis-and-Enrichment.git#egg=slashnext-phishing-ir&subdirectory=Python SDK/src"

{# Link to ccache compiler symlinks #}
ENV CC="/usr/local/bin/gcc"
ENV CXX="/usr/local/bin/g++"
ENV NVCC="/usr/local/bin/nvcc"

{# Clone, build, install #}
RUN cd ${RAPIDS_DIR} \
    && git clone -b ${BUILD_BRANCH} https://github.com/rapidsai/clx.git

# clx build/install
RUN source activate rapids && \
    cd /rapids/clx/python && \
    python setup.py install

{# Link to default compiler executables #}
ENV CC="/usr/bin/gcc"
ENV CXX="/usr/bin/g++"
ENV NVCC="/usr/local/cuda/bin/nvcc"
